<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>River Ryton Water Level — Live Monitoring Worksop & Blyth | Flood Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="Live River Ryton water levels for Worksop and Blyth monitoring stations. Real-time Environment Agency flood data for Nottinghamshire. Check current river conditions and flood risk warnings.">
  <link rel="canonical" href="https://riverryton.com/">
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icon.png">
  <link rel="apple-touch-icon" href="/icon.png">
  
  <meta name="theme-color" content="#f2f2f2">
  <meta name="robots" content="index,follow">
  <meta name="author" content="River Ryton Monitor">
  <meta name="keywords" content="River Ryton water level, Worksop river level, Blyth river level, Nottinghamshire flood monitoring, River Ryton flood risk, Environment Agency river data, Worksop flooding, Blyth flooding, River Ryton conditions, real-time river levels, Nottinghamshire rivers, flood warnings Worksop, flood warnings Blyth">

  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://riverryton.com/">
  <meta property="og:title" content="River Ryton Water Level — Live Monitoring for Worksop & Blyth">
  <meta property="og:description" content="Real-time River Ryton water levels from Environment Agency monitoring stations at Worksop and Blyth. Check flood risk and current river conditions.">
  <meta property="og:image" content="https://riverryton.com/icon.png">
  <meta property="og:site_name" content="River Ryton Water Level Monitor">
  <meta property="og:locale" content="en_GB">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="River Ryton Water Level — Worksop & Blyth">
  <meta name="twitter:description" content="Real-time River Ryton water levels and flood risk monitoring for Worksop and Blyth.">
  <meta name="twitter:image" content="https://riverryton.com/icon.png">

  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "River Ryton Water Level Monitor",
    "url": "https://riverryton.com/",
    "description": "Real-time water level monitoring for River Ryton at Worksop and Blyth using Environment Agency flood monitoring data",
    "about": [
      {
        "@type": "BodyOfWater",
        "name": "River Ryton",
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": "53.308",
          "longitude": "-1.062"
        }
      }
    ],
    "keywords": "River Ryton, water level, flood monitoring, Worksop, Blyth, Nottinghamshire, Environment Agency, flood risk, river gauge",
    "inLanguage": "en-GB",
    "publisher": {
      "@type": "Organization",
      "name": "River Ryton Monitor"
    }
  }
  </script>

  <style>
    :root{
      --bg1:#efefef;
      --bg2:#d9d9d9;
      --text:#111;
      --muted: rgba(0,0,0,.55);
      --faint: rgba(0,0,0,.28);
      --good: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg1:#121316;
        --bg2:#0b0c0e;
        --text:#f4f4f5;
        --muted: rgba(255,255,255,.55);
        --faint: rgba(255,255,255,.30);
      }
    }

    html,body{
      height:100%;
      margin:0;
    }

    body{
      background:
        radial-gradient(
          circle at 50% 42%,
          var(--bg1) 0%,
          var(--bg2) 70%,
          color-mix(in srgb, var(--bg2) 80%, #000) 100%
        );
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      text-rendering: optimizeLegibility;
      position: relative;
      overflow: hidden;
    }

    .charts-bg{
      position: fixed;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: min(100vw, 600px);
      height: 70vh;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: clamp(40px, 8vw, 80px);
      z-index: 0;
      pointer-events: none;
      opacity: 0.65;
    }

    .chart-bar{
      position: relative;
      width: clamp(80px, 14vw, 140px);
      background: var(--good);
      border-radius: 8px 8px 0 0;
      transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    }

    .chart-bar.status-warn{
      background: var(--warn);
    }

    .chart-bar.status-bad{
      background: var(--bad);
    }

    .chart-label{
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: clamp(13px, 2.4vw, 16px);
      font-weight: 800;
      color: rgba(255, 255, 255, 0.95);
      white-space: nowrap;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .chart-value{
      position: absolute;
      bottom: 56px;
      left: 50%;
      transform: translateX(-50%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: clamp(15px, 2.8vw, 18px);
      font-weight: 900;
      color: rgba(255, 255, 255, 0.95);
      white-space: nowrap;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .wrap{
      width:min(980px, calc(100% - 40px));
      text-align:center;
      padding:28px 0;
      position: relative;
      z-index: 1;
    }

    h1, p{
      margin:0;
    }

    .title{
      font-size: clamp(32px, 5.5vw, 58px);
      margin-bottom: 34px;
      letter-spacing: -0.02em;
      font-weight: 800;
    }

    .answer{
      font-size: clamp(28px, 5.2vw, 54px);
      margin-bottom: 36px;
      letter-spacing: -0.02em;
      font-weight: 700;
    }

    .meta{
      margin-top: 18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12px;
      color: var(--muted);
    }

    a{
      color:inherit;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .about-toggle{
      background: var(--text);
      color: var(--bg1);
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin: 0 auto 20px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .about-toggle:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .about-toggle:active{
      transform: translateY(0);
    }

    .bmc-corner{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1000;
    }

    .share-corner{
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 1000;
    }

    .share-btn{
      background: var(--text);
      color: var(--bg1);
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .share-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .share-btn:active{
      transform: translateY(0);
    }

    .share-btn svg{
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    @media (max-width: 600px){
      .about-toggle{
        display: block;
      }
      .about-section{
        display: none;
        transition: all 0.3s ease;
      }
      .about-section.show{
        display: block;
      }
      .charts-bg{
        gap: clamp(30px, 6vw, 60px);
        height: 65vh;
        max-height: 550px;
      }
      .wrap{
        width: min(980px, calc(100% - 24px));
        padding: 60px 0 180px;
      }
      .title{
        margin-bottom: 14px;
        font-size: clamp(24px, 4.8vw, 42px);
      }
      .answer{
        margin-bottom: 16px;
        font-size: clamp(20px, 4.4vw, 40px);
      }
      .bmc-corner{
        right: 12px;
        bottom: 12px;
        transform: scale(0.88);
        transform-origin: bottom right;
      }
      .share-corner{
        left: 12px;
        bottom: 12px;
      }
      .share-btn{
        padding: 10px 18px;
        font-size: 14px;
      }
    }

    @media (max-width: 600px) and (orientation: portrait){
      .charts-bg{
        height: 80vh;
        max-height: 800px;
      }
      .wrap{
        padding: 100px 0 220px;
      }
      .chart-label{
        bottom: 200px;
      }
      .chart-value{
        bottom: 176px;
      }
    }
  </style>
</head>

<body>
  <!-- Background charts -->
  <div class="charts-bg">
    <div class="chart-bar" id="chart1" style="height: 0%;">
      <div class="chart-label">Worksop</div>
      <div class="chart-value" id="chartVal1">—</div>
    </div>
    <div class="chart-bar" id="chart2" style="height: 0%;">
      <div class="chart-label">Blyth</div>
      <div class="chart-value" id="chartVal2">—</div>
    </div>
  </div>

  <main class="wrap">
    <h1 class="title">River Ryton Water Level</h1>

    <p class="answer" id="answer">loading…</p>

    <button class="about-toggle" id="aboutToggle" style="display: none;">ℹ️ About</button>

    <div class="about-section" style="max-width: 560px; margin: 0 auto 28px; padding: 20px; background: color-mix(in srgb, var(--bg2) 50%, transparent); border-radius: 12px; border: 1px solid var(--faint);">
      <p style="margin: 0 0 12px 0; color: var(--text); font-size: 15px; line-height: 1.6; font-weight: 600;">
        About this dashboard
      </p>
      <p style="margin: 0 0 12px 0; color: var(--muted); font-size: 14px; line-height: 1.6;">
        Real-time data from two Environment Agency gauges on the River Ryton (Worksop and Blyth). This is informational only — for official flood warnings use the GOV.UK service.
      </p>
      <p style="margin: 0 0 12px 0; color: var(--muted); font-size: 13px; line-height: 1.5;">
        ⚠️ Property flooding is possible above <strong>1.30m</strong> at Worksop and <strong>1.80m</strong> at Blyth.
      </p>
      <p style="margin: 0; color: var(--muted); font-size: 13px; line-height: 1.5;">
        <a href="https://check-for-flooding.service.gov.uk/station/2121" target="_blank" rel="noopener">Worksop station</a> · 
        <a href="https://check-for-flooding.service.gov.uk/station/2141" target="_blank" rel="noopener">Blyth station</a> · 
        <a href="https://check-for-flooding.service.gov.uk/" target="_blank" rel="noopener">Check for flooding</a>
      </p>
    </div>

    <p class="meta" id="updated">
      Updated: — · 
    </p>
  </main>

  <div class="share-corner">
    <button class="share-btn" id="shareBtn" aria-label="Share this page">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
      </svg>
      Share
    </button>
  </div>

  <div class="bmc-corner" aria-label="Buy me a coffee">
    <script
      type="text/javascript"
      src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
      data-name="bmc-button"
      data-slug="rjcalow"
      data-color="#FFDD00"
      data-emoji=""
      data-font="Cookie"
      data-text="Buy me a coffee"
      data-outline-color="#000000"
      data-font-color="#000000"
      data-coffee-color="#ffffff"
    ></script>
  </div>

  <script>
    const API_URL = "/api/ryton";

    function safeTime(iso){
      if(!iso) return "—";
      try { return new Date(iso).toLocaleString(); }
      catch { return iso; }
    }

    function fmt(n){
      return Number.isFinite(n) ? n.toFixed(2) : "—";
    }

    function levelDecision(worksopLevel, blythLevel){
      // Official EA flood thresholds:
      // Worksop: Property flooding possible above 1.30m
      // Blyth: Property flooding possible above 1.80m
      
      const worksopValid = Number.isFinite(worksopLevel);
      const blythValid = Number.isFinite(blythLevel);
      
      if (!worksopValid && !blythValid) {
        return { answer: "unknown" };
      }

      // Check for flood risk at either station
      const worksopFlooding = worksopValid && worksopLevel >= 1.30;
      const blythFlooding = blythValid && blythLevel >= 1.80;
      
      if (worksopFlooding || blythFlooding) {
        return { answer: "⚠️ flood risk" };
      }

      // Check for above normal (high) levels
      // Worksop normal range: 0.15-1.05m
      // Blyth normal range: 0.42-1.60m
      const worksopHigh = worksopValid && worksopLevel > 1.05;
      const blythHigh = blythValid && blythLevel > 1.60;
      
      if (worksopHigh || blythHigh) {
        return { answer: "high" };
      }

      // Use the higher of the two readings for overall status
      const maxLevel = Math.max(
        worksopValid ? worksopLevel : 0,
        blythValid ? blythLevel : 0
      );

      // Low water (below normal range)
      if (maxLevel < 0.15) {
        return { answer: "very low" };
      }
      
      // Normal levels
      return { answer: "normal" };
    }

    function getStatusColor(level, isWorksop) {
      if (!Number.isFinite(level)) return '';
      
      if (isWorksop) {
        // Worksop: Normal 0.15-1.05m, Property flooding >1.30m
        if (level >= 1.30) return 'status-bad';   // Flood risk
        if (level > 1.05) return 'status-warn';   // Above normal
        return '';                                 // Normal (green)
      } else {
        // Blyth: Normal 0.42-1.60m, Property flooding >1.80m
        if (level >= 1.80) return 'status-bad';   // Flood risk
        if (level > 1.60) return 'status-warn';   // Above normal
        return '';                                 // Normal (green)
      }
    }

    function updateChart(chartId, valueId, value, isWorksop, maxValue = 2.5) {
      const chart = document.getElementById(chartId);
      const valueEl = document.getElementById(valueId);
      if (!chart) return;
      
      // Calculate percentage (cap at 100%)
      const percentage = Math.min((value / maxValue) * 100, 100);
      
      // Update color based on status
      chart.className = 'chart-bar';
      const statusClass = getStatusColor(value, isWorksop);
      if (statusClass) {
        chart.classList.add(statusClass);
      }
      
      // Update value display
      if (valueEl && Number.isFinite(value)) {
        valueEl.textContent = value.toFixed(2) + ' m';
      }
      
      // Animate height
      setTimeout(() => {
        chart.style.height = percentage + '%';
      }, 100);
    }

    async function load(){
      const a = document.getElementById("answer");
      const u = document.getElementById("updated");

      try{
        console.log('Fetching from:', API_URL);
        const res = await fetch(API_URL);
        console.log('Response status:', res.status);
        
        if(!res.ok) {
          const errorText = await res.text();
          console.error('API error response:', errorText);
          throw new Error(`API error: ${res.status}`);
        }
        
        const data = await res.json();
        console.log('API data:', data);
        
        // Extract station data
        const stations = data?.stations || [];
        console.log('Stations:', stations);
        
        if (!stations.length) {
          throw new Error('No station data received');
        }
        
        // Find Worksop (4049) and Blyth (4091)
        const worksop = stations.find(s => s.stationId === "4049");
        const blyth = stations.find(s => s.stationId === "4091");
        
        console.log('Worksop:', worksop);
        console.log('Blyth:', blyth);
        
        const worksopLevel = worksop?.latest?.value;
        const blythLevel = blyth?.latest?.value;
        
        console.log('Levels:', { worksopLevel, blythLevel });
        
        // Get latest timestamp
        const latestTime = worksop?.latest?.dateTime || blyth?.latest?.dateTime;
        
        const result = levelDecision(worksopLevel, blythLevel);

        a.textContent = result.answer;
        
        // Update background charts with color coding
        updateChart('chart1', 'chartVal1', worksopLevel || 0, true);
        updateChart('chart2', 'chartVal2', blythLevel || 0, false);
        
        u.innerHTML = `Updated: ${safeTime(latestTime)} ·`;
      }
      catch(e){
        console.error('Load error:', e);
        a.textContent = "can't tell right now.";
        u.innerHTML = `Error: ${e.message} · Check console for details`;
      }
    }

    // About section toggle (mobile)
    const aboutToggle = document.getElementById("aboutToggle");
    const aboutSection = document.querySelector(".about-section");
    
    if (aboutToggle && aboutSection) {
      aboutToggle.addEventListener("click", () => {
        aboutSection.classList.toggle("show");
        aboutToggle.textContent = aboutSection.classList.contains("show") ? "✕ Close" : "ℹ️ About";
      });
    }

    // Share functionality
    document.getElementById("shareBtn").addEventListener("click", async () => {
      const shareData = {
        title: "River Ryton Water Level",
        text: "Check River Ryton water levels in real-time for kayaking and fishing!",
        url: window.location.href
      };

      // Try native Web Share API first (works on mobile)
      if (navigator.share) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          // User cancelled or error - do nothing
          if (err.name !== 'AbortError') {
            console.log('Share failed:', err);
          }
        }
      } else {
        // Fallback: copy link to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);
          const btn = document.getElementById("shareBtn");
          const originalText = btn.innerHTML;
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg> Copied!';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        } catch (err) {
          console.log('Copy failed:', err);
          alert('Link: ' + window.location.href);
        }
      }
    });

    load();
  </script>
</body>
</html>
