<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>River Ryton water level — Worksop & Blyth</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root{
      --bg:#f7f7fb; --text:#0b0d12; --muted:#667085;
      --stroke:rgba(0,0,0,0.12);
      --card:rgba(255,255,255,0.76);
      --shadow:0 18px 44px rgba(0,0,0,0.10);
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --w:#6aa6ff; --b:#ff6ad5;
      --glass: blur(10px);
      --header-h:56px;
      --max:2.50;           /* display scale (m) */
      --t1:1.05;            /* normal top (m) */
      --t2:1.30;            /* property possible (m) */
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0d12; --text:#f2f4f8; --muted:#aab3c2;
        --stroke:rgba(255,255,255,0.14);
        --card:rgba(18,22,34,0.76);
        --shadow:0 22px 60px rgba(0,0,0,0.55);
      }
    }
    html[data-theme="light"]{
      color-scheme: light;
      --bg:#f7f7fb; --text:#0b0d12; --muted:#667085;
      --stroke:rgba(0,0,0,0.12);
      --card:rgba(255,255,255,0.76);
      --shadow:0 18px 44px rgba(0,0,0,0.10);
    }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg:#0b0d12; --text:#f2f4f8; --muted:#aab3c2;
      --stroke:rgba(255,255,255,0.14);
      --card:rgba(18,22,34,0.76);
      --shadow:0 22px 60px rgba(0,0,0,0.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      overflow:hidden;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* fixed top bar */
    .topbar{
      position:fixed; top:0; left:0; right:0; z-index:50;
      border-bottom:1px solid var(--stroke);
      background: color-mix(in srgb, var(--bg) 82%, transparent);
      backdrop-filter: var(--glass);
    }
    .topbarInner{
      width:min(860px, 100%);
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:900; letter-spacing:-0.02em; }
    .dot{ width:9px; height:9px; border-radius:50%; background:linear-gradient(135deg,var(--good),var(--warn),var(--bad)); }
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    /* scroll snap container */
    #appScroll{
      height:100vh;
      padding-top:var(--header-h);
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:y mandatory;
      scroll-behavior:smooth;
    }
    section{
      min-height:calc(100vh - var(--header-h));
      scroll-snap-align:start;
      padding:18px 16px calc(18px + env(safe-area-inset-bottom));
      display:flex;
      align-items:center;
      justify-content:center;
    }
    @media (prefers-reduced-motion: reduce){
      #appScroll{ scroll-snap-type:none; scroll-behavior:auto; }
    }

    .wrap{ width:min(860px, 100%); display:grid; gap:12px; }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: var(--glass);
    }
    .muted{ color:var(--muted); }
    .tiny{ font-size:12px; }
    a{ color:inherit; text-decoration:underline; text-underline-offset:3px; }

    /* ---------- Waterline postcard graphic ---------- */
    .postcard{
      position:relative;
      border-radius:26px;
      border:1px solid var(--stroke);
      overflow:hidden;
      height:min(64vh, 540px);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
    }

    /* Bands are vertical (top=red, middle=amber, bottom=green) */
    .band{ position:absolute; left:0; right:0; }
    .band.good{ background: color-mix(in srgb, var(--good) 18%, transparent); }
    .band.warn{ background: color-mix(in srgb, var(--warn) 18%, transparent); }
    .band.bad { background: color-mix(in srgb, var(--bad) 18%, transparent); }

    /* The big waterline */
    .waterline{
      position:absolute;
      left:0; right:0;
      height:3px;
      background: color-mix(in srgb, var(--text) 85%, transparent);
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
    }
    .stationLine{
      height: 10px;
      border-radius: 999px;
      opacity: 1;                 /* we control visibility via gradients */
      box-shadow: none;
      mix-blend-mode: normal;     /* stop it washing out */
    }

    /* Worksop line: solid core + glow */
    .stationLine.worksop{
      background:
        linear-gradient(to bottom,
          transparent 0%,
          color-mix(in srgb, var(--w) 70%, transparent) 35%,
          color-mix(in srgb, var(--w) 95%, transparent) 50%,
          color-mix(in srgb, var(--w) 70%, transparent) 65%,
          transparent 100%);
      filter: drop-shadow(0 0 10px color-mix(in srgb, var(--w) 55%, transparent));
    }

    /* Blyth line: solid core + glow */
    .stationLine.blyth{
      background:
        linear-gradient(to bottom,
          transparent 0%,
          color-mix(in srgb, var(--b) 70%, transparent) 35%,
          color-mix(in srgb, var(--b) 95%, transparent) 50%,
          color-mix(in srgb, var(--b) 70%, transparent) 65%,
          transparent 100%);
      filter: drop-shadow(0 0 10px color-mix(in srgb, var(--b) 55%, transparent));
    }

    /* Subtle wave shimmer (optional, still minimal) */
    .waterline::after{
      content:"";
      position:absolute; inset:-10px 0 -10px 0;
      background: radial-gradient(closest-side, color-mix(in srgb, var(--text) 18%, transparent), transparent 70%);
      opacity:0.25;
      filter: blur(10px);
    }
    .marker{
      position:absolute;
      left:0; right:0;
      height:0;
      border-top:1px dashed color-mix(in srgb, var(--text) 55%, transparent);
      pointer-events:none;
    }
    .markerLabel{
      position:absolute;
      right:10px;
      top:-10px;
      font-size:11px;
      color:var(--muted);
      background: color-mix(in srgb, var(--bg) 80%, transparent);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:2px 6px;
      white-space:nowrap;
    }

    /* Tick marks on left */
    .ticks{
      position:absolute; inset:0;
      padding:16px;
      pointer-events:none;
    }
    .tick{
      position:absolute;
      left:16px;
      width:22px;
      height:1px;
      background: color-mix(in srgb, var(--stroke) 55%, transparent);
    }
    .tickLabel{
      position:absolute;
      left:44px;
      transform: translateY(50%);
      font-size:11px;
      color:var(--muted);
    }

    /* Flag markers */
    .flag{
      position:absolute;
      transform: translateY(-50%);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--bg) 76%, transparent);
      backdrop-filter: var(--glass);
      box-shadow: 0 14px 34px rgba(0,0,0,0.14);
      font-size:12px;
      font-weight:900;
      letter-spacing:-0.01em;
      white-space:nowrap;
    }
    .flag .pin{
      width:10px; height:10px; border-radius:50%;
      background: var(--text);
      flex:0 0 auto;
    }
    .flag .val{ font-weight:950; }
    .flag .dot{
      width:10px; height:10px; border-radius:50%;
      background: transparent;
      border:1px solid var(--stroke);
      flex:0 0 auto;
    }

    .legend{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background: transparent;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand"><span class="dot"></span><span>River Ryton</span></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="refreshBtn" type="button">Refresh</button>
        <button class="btn" id="themeBtn" type="button">Theme</button>
      </div>
    </div>
  </header>

  <main id="appScroll">
    <!-- 1) HERO -->
    <section id="live">
      <div class="wrap">
        <div class="card">
          <div class="legend">
            <div class="muted tiny" id="updatedText">Updated: —</div>
            <div class="pill tiny">Auto refreshes every 15 min</div>
            <div class="pill tiny">Bands: Normal (green) · High (amber) · Risk (red)</div>
          </div>
        </div>

        <div class="card postcard" aria-label="Waterline postcard graphic">
          <!-- bands -->
          <div class="band good" id="bandGood"></div>
          <div class="band warn" id="bandWarn"></div>
          <div class="band bad"  id="bandBad"></div>

          <!-- risk markers -->
          <div class="marker" id="markerWorksop">
            <span class="markerLabel" id="labelWorksop">Worksop risk —</span>
          </div>
          <div class="marker" id="markerBlyth">
            <span class="markerLabel" id="labelBlyth">Blyth risk —</span>
          </div>

          <!-- ticks -->
          <div class="ticks" id="ticks"></div>

          <!-- waterline -->
          <div class="waterline" id="waterline"></div>
          <div class="waterline stationLine worksop" id="lineWorksop"></div>
          <div class="waterline stationLine blyth" id="lineBlyth"></div>

          <!-- flags -->
          <div class="flag" id="flagWorksop" style="left:14px;">
            <span class="pin" style="background:var(--w)"></span>
            Worksop <span class="val" id="wVal">—</span>
            <span class="dot" id="wDot" title="status"></span>
          </div>

          <div class="flag" id="flagBlyth" style="right:14px;">
            <span class="pin" style="background:var(--b)"></span>
            Blyth <span class="val" id="bVal">—</span>
            <span class="dot" id="bDot" title="status"></span>
          </div>
        </div>

        <div class="card">
          <div class="legend">
            <div class="pill" id="wStatus">Worksop: —</div>
            <div class="pill" id="bStatus">Blyth: —</div>
            <div class="muted tiny">↓ Scroll for info</div>
          </div>
          <div class="muted tiny" id="errLine" style="margin-top:10px; min-height:16px;"></div>
        </div>
      </div>
    </section>

    <!-- 2) INFO -->
    <section id="info">
      <div class="wrap">
        <div class="card">
          <p style="margin:0; font-weight:950;">About</p>
          <p class="muted" style="margin:10px 0 0 0; line-height:1.6;">
            Dashboard for two gauges on the River Ryton (Worksop and Blyth). This is informational only.
            For official flood warnings use the GOV.UK service.
          </p>
          <p class="muted tiny" style="margin:10px 0 0 0;">
            Property flooding is possible above 1.30m at Worksop and 1.80m at Blyth.
          </p>
          <p class="muted tiny" style="margin:10px 0 0 0;">
            <a href="https://check-for-flooding.service.gov.uk/station/2121" target="_blank" rel="noopener">Worksop station</a> ·
            <a href="https://check-for-flooding.service.gov.uk/station/2141" target="_blank" rel="noopener">Blyth station</a> ·
            <a href="https://check-for-flooding.service.gov.uk/" target="_blank" rel="noopener">Check for flooding</a>
          </p>
        </div>

        <div class="card">
          <p style="margin:0; font-weight:950;">Map</p>
          <div style="margin-top:10px; border-radius:18px; overflow:hidden; border:1px solid var(--stroke);">
            <iframe
              title="River Ryton area map"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              src="https://www.openstreetmap.org/export/embed.html?bbox=-1.060%2C53.300%2C-0.850%2C53.410&layer=mapnik"
              style="width:100%; height:320px; border:0; display:block;">
            </iframe>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) SUPPORT -->
    <section id="support">
      <div class="wrap">
        <div class="card">
          <p style="margin:0; font-weight:950;">Support</p>
          <p class="muted" style="margin:10px 0 0 0; line-height:1.6;">
            If you want to keep this dashboard online and improve it (better map, more stations), you can support the project.
          </p>
          <p>
            <script
              type="text/javascript"
              src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
              data-name="bmc-button"
              data-slug="rjcalow"
              data-color="#FFDD00"
              data-emoji=""
              data-font="Cookie"
              data-text="Buy me a coffee"
              data-outline-color="#000000"
              data-font-color="#000000"
              data-coffee-color="#ffffff">
            </script>
            </p>
            <p><span class="muted tiny">Attribution: “this uses Environment Agency flood and river level data from the real-time data API (Beta)”.</span>
          </p>
        </div>

      </div>
    </section>
  </main>

  <script>
    const API_URL = "/api/ryton";

    // thresholds (m)
    const maxScaleM = 2.50;
    const t1 = 1.05; // normal top
    const t2Worksop = 1.30; // property possible
    const t2Blyth = 1.80;   // property possible

    // theme toggle
    (function(){
      const root = document.documentElement;
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      const saved = localStorage.getItem("rrw_theme");
      if (saved === "light" || saved === "dark") root.dataset.theme = saved;
      if (metaTheme) metaTheme.setAttribute("content", root.dataset.theme === "dark" ? "#0b0d12" : "#f7f7fb");

      const themeBtn = document.getElementById("themeBtn");
      if (!themeBtn) return;
      themeBtn.addEventListener("click", () => {
        const cur = root.dataset.theme || "";
        const next = (cur === "dark") ? "light" : "dark";
        root.dataset.theme = next;
        localStorage.setItem("rrw_theme", next);
        if (metaTheme) metaTheme.setAttribute("content", next === "dark" ? "#0b0d12" : "#f7f7fb");
      });
    })();

    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const pct = (m)=> (typeof m==="number") ? clamp((m/maxScaleM)*100,0,100) : 0;
    const fmt = (iso)=>{ if(!iso) return "—"; try{return new Date(iso).toLocaleString();}catch{return iso;} };

    function statusFor(m, warnTop, riskTop){
      if (typeof m !== "number") return { text:"No data", color:"transparent" };
      if (m >= riskTop) return { text:"Risk",   color:"var(--bad)" };
      if (m >= warnTop) return { text:"High",   color:"var(--warn)" };
      return            { text:"Normal", color:"var(--good)" };
    }

    function initBandsAndTicks(){
      // bands are vertical, so we set from bottom
      const goodTop = pct(t1);
      const warnTop = pct(t2Worksop);

      const bandGood = document.getElementById("bandGood");
      const bandWarn = document.getElementById("bandWarn");
      const bandBad  = document.getElementById("bandBad");

      bandGood.style.bottom = "0%";
      bandGood.style.height = goodTop + "%";

      bandWarn.style.bottom = goodTop + "%";
      bandWarn.style.height = (warnTop - goodTop) + "%";

      bandBad.style.bottom = warnTop + "%";
      bandBad.style.height = (100 - warnTop) + "%";

      const markerWorksop = document.getElementById("markerWorksop");
      const markerBlyth = document.getElementById("markerBlyth");
      const labelWorksop = document.getElementById("labelWorksop");
      const labelBlyth = document.getElementById("labelBlyth");
      if (markerWorksop){
        markerWorksop.style.bottom = pct(t2Worksop) + "%";
        if (labelWorksop) labelWorksop.textContent = "Worksop risk " + t2Worksop.toFixed(2) + "m";
      }
      if (markerBlyth){
        markerBlyth.style.bottom = pct(t2Blyth) + "%";
        if (labelBlyth) labelBlyth.textContent = "Blyth risk " + t2Blyth.toFixed(2) + "m";
      }

      // ticks on left (every 0.5m)
      const ticks = document.getElementById("ticks");
      ticks.innerHTML = "";
      for (let m=0; m<=maxScaleM+0.0001; m+=0.5){
        const d = document.createElement("div");
        d.className = "tick";
        d.style.bottom = pct(m) + "%";
        ticks.appendChild(d);

        if (m > 0 && m < maxScaleM - 0.0001){
          const lbl = document.createElement("div");
          lbl.className = "tickLabel";
          lbl.style.bottom = pct(m) + "%";
          lbl.textContent = m.toFixed(1) + "m";
          ticks.appendChild(lbl);
        }
      }
    }

    function setY(el, m){
      el.style.bottom = pct(m) + "%";
    }

    async function load(){
      const err = document.getElementById("errLine");
      err.textContent = "";

      const btn = document.getElementById("refreshBtn");
      btn.textContent = "Refreshing…";
      btn.disabled = true;

      try{
        const res = await fetch(API_URL, { headers:{ "Accept":"application/json" }});
        if (!res.ok) throw new Error("API HTTP " + res.status);
        const data = await res.json();

        const stations = Array.isArray(data?.stations) ? data.stations : [];
        const worksop = stations.find(s => /worksop/i.test(s.label || "")) || stations[0];
        const blyth   = stations.find(s => /blyth/i.test(s.label || "")) || stations[1];

        const w = worksop?.latest?.value;
        const wt = worksop?.latest?.dateTime;
        const b = blyth?.latest?.value;
        const bt = blyth?.latest?.dateTime;

        // Move the BIG waterline based on the higher reading (feels like “overall” waterline)
        const maxReading = Math.max(typeof w==="number"?w:0, typeof b==="number"?b:0);
        setY(document.getElementById("waterline"), maxReading);

        // Place the flags at their own heights
        setY(document.getElementById("flagWorksop"), (typeof w==="number")?w:0);
        setY(document.getElementById("flagBlyth"),   (typeof b==="number")?b:0);

        // Soft waterlines for each station reading
        setY(document.getElementById("lineWorksop"), (typeof w === "number") ? w : 0);
        setY(document.getElementById("lineBlyth"),   (typeof b === "number") ? b : 0);

        document.getElementById("wVal").textContent = (typeof w==="number") ? (w.toFixed(2) + "m") : "—";
        document.getElementById("bVal").textContent = (typeof b==="number") ? (b.toFixed(2) + "m") : "—";

        const ws = statusFor(w, t1, t2Worksop);
        const bs = statusFor(b, t1, t2Blyth);

        document.getElementById("wDot").style.background = ws.color;
        document.getElementById("bDot").style.background = bs.color;

        document.getElementById("wStatus").textContent = "Worksop: " + ws.text;
        document.getElementById("bStatus").textContent = "Blyth: " + bs.text;

        const newest = [wt, bt].filter(Boolean).sort().slice(-1)[0] || null;
        document.getElementById("updatedText").textContent = "Updated: " + fmt(newest);

      }catch(e){
        console.error(e);
        err.textContent = "Couldn’t load live data. " + (e?.message || "Unknown error");
      }finally{
        btn.textContent = "Refresh";
        btn.disabled = false;
      }
    }

    initBandsAndTicks();
    load();
    const refreshBtn = document.getElementById("refreshBtn");
    if (refreshBtn) refreshBtn.addEventListener("click", load);
    setInterval(load, 15 * 60 * 1000);
  </script>
</body>
</html>
